#!/usr/bin/env ruby

BASEDIR = File.dirname(__FILE__) + "/.."

$:.insert(0, BASEDIR + "/lib")
require "sinatra"
require "uri"
require "json"
require "findit/app"

set :public_folder, BASEDIR + "/public"

get "/" do
  redirect to("/index.html")
end

get "/svc/nearby/:lat,:lng" do |lat, lng|
  features = FindIt::App::nearby(lat.to_f, lng.to_f)
  content_type :json
  features.map{|f| f.to_h}.to_json
end

post "/svc/nearby" do
  a = URI.decode_www_form(request.body.read)
  lat = (a.assoc("latitude") || []).last
  lng = (a.assoc("longitude") || []).last
  features = FindIt::App::nearby(lat.to_f, lng.to_f)
  content_type :json
  features.map{|f| f.to_h}.to_json
end
